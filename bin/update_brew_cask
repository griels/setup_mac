#!/usr/bin/env ruby
require 'pathname'
unless ''.respond_to?(:scrub)
  STDERR.puts 'use ruby version >= 2.1.0 or install https://github.com/hsbt/string-scrub'
  exit!
end
EXCEPT_PACKAGE = %w(
  microsoft-office
).freeze
MAX_RETRY_COUNT = 5
CASK_LIST = (`brew cask list`.split("\n") - EXCEPT_PACKAGE).freeze
CASK_DIR  = Pathname(`echo $(brew --prefix)/Caskroom`.delete("\n")).freeze

# Retries with Exponential Backoff
def with_retry!(max_attempt_count: 5, sleep_second: 60, &block)
  attempt_count = 0

  while attempt_count < max_attempt_count
    attempt_count += 1
    begin
      res = yield
      return res
    rescue
      puts "attempt #{attempt_count} failed, sleep #{sleep_second} sec and retry..."
      sleep sleep_second
      sleep_second *= 2
    end
  end
  raise "Exceed maximum attempt"
end

with_retry! do
  result = system 'brew update'
  raise unless result
end

CASK_LIST.each do |package_name|
  package_info = `brew cask info #{package_name}`.scrub
  package_dir  = CASK_DIR + package_name

  # note: capture current version withou "(does not exist)"
  #       see https://github.com/caskroom/homebrew-cask/issues/24873
  current_version = package_info[%r{^#{package_dir}/(.+?)\s\((?!does not exist).+$}, 1]
  latest_version  = package_info[/^#{package_name}: (.+)$/, 1]

  next if current_version == latest_version

  puts "update #{package_name} from #{current_version} to #{latest_version}.."
  system "brew cask install --force #{package_name} && mv #{package_dir + current_version} ~/.Trash/"
end

system 'brew cask cleanup'
