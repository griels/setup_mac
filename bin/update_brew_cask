#!/usr/bin/env ruby
require 'pathname'

system 'brew update'
CASK_LIST = `brew cask list`.split("\n").freeze
CASK_DIR  = Pathname(`echo $(brew --prefix)/Caskroom`.delete("\n")).freeze

CASK_LIST.each do |package_name|
  package_info = `brew cask info #{package_name}`.scrub
  package_dir  = CASK_DIR + package_name

  # note: capture current version withou "(does not exist)"
  #       see https://github.com/caskroom/homebrew-cask/issues/24873
  current_version = package_info[/^#{package_dir}\/(.+?)\s\((?!does not exist).+$/, 1]
  latest_version  = package_info[/^#{package_name}: (.+)$/, 1]

  if current_version != latest_version
    puts "update #{package_name} from #{current_version} to #{latest_version}..."
    system "brew cask install --force #{package_name}"
    system "mv #{package_dir + current_version} ~/.Trash/"
  end
end

system 'brew cask cleanup'
